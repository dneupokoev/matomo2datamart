# matomo2datamart

Matomo to DataMart: Создание витрин данных из Matomo

Для работы потребуется Linux (тестирование проводилось на ubuntu 22.04.01). При необходимости переписать под windows, вероятно, вам не составит большого труда.

Сначала всё настроить, потом вручную запускать проект: ```matomo2datamart_start.sh```

Для автоматизации можно настроить (например, через cron) выполнение скрипта ```matomo2datamart.py```

### Кратко о том как устроена работа matomo2datamart:

- matomo2datamart создает витрины из данных Matomo и сохраняет их в ClickHouse

### Кратко весь процесс настройки:

- Создать таблицы в ClickHouse (для создания таблиц выполнить скрипт из проекта с учетом своих настроек)
- Настроить запуск matomo2datamart по нужному вам расписанию

***ВНИМАНИЕ! Пути до каталогов и файлов везде указывайте свои!***


### ClickHouse

- Для создания структуры выполнить скрипт: ```script_create_clickhouse_table.sql``` (ВНИМАНИЕ!!! сначала необходимо изучить скрипт! и отредактировать под свои требования)
- Если потребуются дополнительные таблицы, то читать описание внутри ```settings.py```

### Установка matomo2datamart (выполняем пошагово)

- Устанавливаем python (тестирование данной инструкции проводилось на 3.10, на остальных версиях работу не гарантирую, но должно работать на версиях 3.9+, если
  вам потребуется, то без особенного труда сможете переписать даже под 2.7)

- Matomo может использовать MySQL/MariaDB/Percona или другие DB семейства MySQL, далее будем это всё называть MySQL.
Для работы python с MySQL скорее всего сначала потребуется установить клиентскую библиотеку для ОС, поэтому пробуем установить:

```
sudo apt install libmysqlclient-dev
```

- Устанавливаем pip:

```
sudo apt install python3-pip
```

- Далее устанавливаем pipenv (на linux):

```
pip3 install pipenv
```

- Создаем нужный каталог в нужном нам месте
- Копируем в этот каталог файлы проекта https://github.com/dneupokoev/matomo2datamart
- Заходим в созданный каталог и создаем в нем пустой каталог .venv
- В каталоге проекта выполняем команды (либо иным способом устанавливаем требующиеся для работы пакеты):

```
pipenv shell
```

```
pipenv sync
```

- Редактируем и переименовываем файл ```_settings.py``` в ```settings.py``` (описание внутри файла)
- Настраиваем регулярное выполнение (например, через cron) скрипта:

```
matomo2datamart.py
```

### Дополнительно

- Обратите внимание на описание внутри ```settings.py``` - там все настройки
- Если работает экземпляр программы, то второй экземпляр запускаться не будет (отслеживается через создание и проверку наличия файла)
- Записывается лог ошибок (настраивается в settings, рекомендуется сюда: /var/log/matomo2datamart/)
- Если задать нужные настройки в ```settings.py```, то результат работы будет присылать в телеграм (в личку или указанный канал)
- Можно включить (в ```settings.py```) вывод информации о дисковом пространстве

### Добавления задания в cron

Смотрим какие задания уже созданы для данного пользователя:

```
crontab -l
```

Открываем файл для создания задания:

```
crontab -e
```

Каждая задача формируется следующим образом (для любого значения нужно использовать звездочку "*"):

```
минута(0-59) час(0-23) день(1-31) месяц(1-12) день_недели(0-7) /полный/путь/к/команде
```

Чтобы matomo2datamart запускался каждый день в 2 часа (ночью) ровно в 15 минут, создаем строку и сохраняем файл:

```
15 2 * * * /opt/dix/matomo2datamart/matomo2datamart_cron.sh
```

ВНИМАНИЕ!!! отредактируйте содержимое файла ```matomo2datamart_cron.sh``` и сделайте его исполняемым

### Возможные проблемы и их решение

- При выполнении скрипта появилась ЛЮБАЯ ошибка.
Нужно в файле ```settings.py``` заменить (запомните как настроено, когда почините, нужно будет вернуть) значения параметров так:
```
DEBUG = True
```
Запустить скрипт вручную. Изучить логи! 


### ВНИМАНИЕ!

- Перед обновлением matomo НЕОБХОДИМО (!!!) изучить что меняется. В случае, если меняется структура базы данных, то возможно витрины нужно будет подправить.
- Ключевые таблицы matomo:
```
log_visit - содержит одну запись за посещение (данные о сессии: начало, конец, инфа о посетителе, стандартные utm и т.д.)
log_action - содержит все типы действий, возможных на веб-сайте (например, уникальные URL-адреса, заголовки страниц, URL-адреса загрузки и т.д.)
log_link_visit_action - содержит одну запись на каждое действие посетителя (просмотр страницы, т.д.)
log_conversion - содержит конверсии (действия, соответствующие цели), которые произошли во время посещения
log_conversion_item - содержит элементы конверсии электронной коммерции
```

### Версии

230605.01:
+ начало работы над проектом




